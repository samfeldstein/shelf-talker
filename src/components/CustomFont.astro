---
import OptionsBox from "./OptionsBox.astro";
---

<OptionsBox
  buttonId="customFontBtn"
  divId="customFontDiv"
  buttonLabel="Change font"
>
  <label for="fontLinkInput">
    Paste your Google Fonts code below. For help, see
    <a href="/help#fonts">Adding fonts</a>.
  </label>
  <textarea
    id="fontLinkInput"
    rows="3"
    cols="60"
    placeholder='<link href="https://fonts.googleapis.com/css2?family=..." rel="stylesheet">'
  ></textarea>
  <button class="done">Done</button>
</OptionsBox>

<script>
  // Focus textarea
  const showButton = document.getElementById("customFontBtn");
  showButton?.addEventListener("click", () => {
    const textarea = document.getElementById("fontLinkInput");
    textarea?.focus();
  });

  // Inject font
  function injectFont(href) {
    // Remove existing font links
    document.querySelectorAll('link[rel="stylesheet"]').forEach((l) => {
      if (l.href.includes("fonts.googleapis.com")) l.remove();
    });

    // If link already exists, do nothing
    if (document.querySelector(`link[href="${href}"]`)) return;

    // Build the <link> element and put it in the <head>
    const linkEl = document.createElement("link");
    linkEl.rel = "stylesheet";
    linkEl.href = href;
    document.head.appendChild(linkEl);

    // Apply font to cards
    const match = href.match(/family=([^:&"]+)/);
    if (!match) return;
    const fontName = match[1].split(":")[0].replace(/\+/g, " ");
    const container = document.getElementById("cardContainer");
    if (container) container.style.fontFamily = `'${fontName}', serif`;
  }

  function processFontInput() {
    const textareaEl = document.getElementById("fontLinkInput");
    if (!textareaEl) return;

    const raw = textareaEl.value.trim();
    if (!raw) return;

    const doc = new DOMParser().parseFromString(raw, "text/html");
    const link = doc.querySelector(
      'link[rel="stylesheet"][href*="fonts.googleapis.com"]',
    );
    if (!link) return;

    const href = link.href;
    localStorage.setItem("googleFontLink", href);
    injectFont(href);
    textareaEl.value = "";
  }

  // Load font
  document.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("googleFontLink");
    if (saved) injectFont(saved);

    const textarea = document.getElementById("fontLinkInput");
    if (textarea) {
      textarea.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === "Escape") {
          e.preventDefault();
          processFontInput();
        }
      });
    }

    // Handle Done button click
    const doneButton = document.querySelector(".done");
    if (doneButton) {
      doneButton.addEventListener("click", () => {
        processFontInput();
        const box = doneButton.closest(".options-box");
        if (box) box.classList.add("hidden");
      });
    }
  });
</script>
