<div hidden>
  <label for="fontLinkInput"
    >Paste your Google Fonts code below. For help, see <a href="/help#fonts"
      >Adding fonts</a
    >.</label
  >
  <textarea id="fontLinkInput" rows="3" cols="60"></textarea>
</div>

<style>
  textarea {
    display: block;
  }
</style>

<script>
  // Load saved fonts
  window.addEventListener("DOMContentLoaded", () => {
    const savedFontLink = localStorage.getItem("googleFontLink");
    if (savedFontLink) {
      // Put it into the textarea for display
      document.getElementById("fontLinkInput").value = savedFontLink;

      // Inject it into the page
      injectFontLinkFromHTML(savedFontLink);
    }
  });

  // Get the textarea
  const textarea = document.getElementById("fontLinkInput");

  // On Enter or blur, process the input
  textarea.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      injectFontLink();
    }
  });

  textarea.addEventListener("blur", injectFontLink);

  // Function to inject the pasted <link> tag into <head>
  function injectFontLink() {
    const input = textarea.value.trim();
    if (!input) return;

    injectFontLinkFromHTML(input);
    localStorage.setItem("googleFontLink", input);
  }

  function injectFontLinkFromHTML(input) {
    if (!input) return;

    // Remove old Google Fonts links
    const existing = document.head.querySelectorAll('link[rel="stylesheet"]');
    for (const link of existing) {
      if (link.href.includes("fonts.googleapis.com")) {
        link.remove();
      }
    }

    // Insert new <link> tag
    document.head.insertAdjacentHTML("beforeend", input);

    // Extract href
    const hrefMatch = input.match(/href="([^"]+)"/);
    if (!hrefMatch) return;

    const href = hrefMatch[1];
    const familyMatch = href.match(/family=([^:&"]+)/);
    if (!familyMatch) return;

    const rawName = familyMatch[1];
    const fontName = rawName.replace(/\+/g, " ");

    // Apply font
    document.body.style.fontFamily = `'${fontName}', sans-serif`;
    console.log(fontName);
  }
</script>
